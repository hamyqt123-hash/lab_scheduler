{% extends "base.html" %}
{% block content %}

<h3 class="mb-3">Báo cáo sử dụng phòng thực hành (theo tuần / khoảng thời gian)</h3>

<div class="d-flex flex-wrap gap-2 mb-3">
  <a class="btn btn-outline-primary btn-sm" href="{{ url_for('admin_monthly_report') }}">Theo tháng</a>
  <a class="btn btn-primary btn-sm" href="{{ url_for('admin_reports') }}">Theo tuần / khoảng thời gian</a>
  <a class="btn btn-secondary btn-sm" href="{{ url_for('dashboard') }}">Quay lại</a>
</div>

<form method="post" class="card p-3 mb-4">
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <label class="form-label">Chế độ</label>
      <select name="mode" id="modeSelect" class="form-select">
        <option value="week" {% if mode == 'week' %}selected{% endif %}>Theo tuần</option>
        <option value="range" {% if mode == 'range' %}selected{% endif %}>Theo khoảng thời gian</option>
      </select>
    </div>

    <div class="col-md-5" id="weekBox">
      <label class="form-label">Chọn tuần</label>
      <select name="week_id" class="form-select">
        <option value="">-- Chọn tuần --</option>
        {% for w in weeks %}
          <option value="{{ w.id }}" {% if week_id and (week_id|int) == w.id %}selected{% endif %}>
            {{ w.school_year }} - Tuần {{ w.week_no }} ({{ w.start_date.strftime('%d/%m/%Y') }}→{{ w.end_date.strftime('%d/%m/%Y') }}){% if not w.is_active %} [TẮT]{% endif %}
          </option>
        {% endfor %}
      </select>
      <div class="form-text">
        Nếu không thấy tuần: hãy khai báo ở <b>Quản lý tuần đăng ký</b> (và bật tuần nếu cần).
      </div>
    </div>

    <div class="col-md-2" id="startBox">
      <label class="form-label">Từ ngày</label>
      <input type="date" name="start_date" class="form-control"
             value="{{ start_str or (start_date.isoformat() if start_date else '') }}">
    </div>

    <div class="col-md-2" id="endBox">
      <label class="form-label">Đến ngày</label>
      <input type="date" name="end_date" class="form-control"
             value="{{ end_str or (end_date.isoformat() if end_date else '') }}">
    </div>

    <div class="col-md-12">
      <button class="btn btn-primary">Xem báo cáo</button>
    </div>
  </div>
</form>

{% if has_result %}
  <div class="alert alert-info">
    Phạm vi báo cáo: <b>{{ range_label }}</b>
  </div>

  <h5 class="mt-4">Báo cáo theo giáo viên</h5>
  <div class="table-responsive mb-4">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th style="width:60px;">#</th>
          <th>Giáo viên</th>
          <th style="width:180px;">Tổ/nhóm</th>
          <th style="width:150px;">SĐT</th>
          <th style="width:160px;">Số tiết thực hành</th>
        </tr>
      </thead>
      <tbody>
        {% if teacher_stats and teacher_stats|length > 0 %}
          {% for t in teacher_stats %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ t.full_name }}</td>
              <td>{{ t.group_name or '' }}</td>
              <td>{{ t.phone or '' }}</td>
              <td>{{ t.total_periods }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" class="text-muted">Không có dữ liệu trong phạm vi đã chọn.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <h5 class="mt-4">Báo cáo tổng hợp theo phòng</h5>
  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th style="width:60px;">#</th>
          <th>Phòng</th>
          <th style="width:180px;">Nhóm phòng</th>
          <th style="width:180px;">Số tiết sử dụng</th>
        </tr>
      </thead>
      <tbody>
        {% if lab_stats and lab_stats|length > 0 %}
          {% for l in lab_stats %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ l.name }}</td>
              <td>{{ l.subject_group }}</td>
              <td>{{ l.total_periods }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="4" class="text-muted">Không có dữ liệu trong phạm vi đã chọn.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="alert alert-warning">
    Chưa có dữ liệu để hiển thị. Hãy chọn tuần hoặc nhập khoảng ngày rồi bấm <b>Xem báo cáo</b>.
  </div>
{% endif %}

<script>
(function(){
  const modeSelect = document.getElementById('modeSelect');
  const weekBox = document.getElementById('weekBox');
  const startBox = document.getElementById('startBox');
  const endBox = document.getElementById('endBox');

  function sync(){
    const mode = (modeSelect && modeSelect.value) ? modeSelect.value : 'week';
    if(mode === 'week'){
      weekBox.style.display = '';
      startBox.style.display = 'none';
      endBox.style.display = 'none';
    } else {
      weekBox.style.display = 'none';
      startBox.style.display = '';
      endBox.style.display = '';
    }
  }

  if(modeSelect){
    modeSelect.addEventListener('change', sync);
    sync();
  }
})();
</script>

{% endblock %}
