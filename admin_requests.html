{% extends "base.html" %}
{% block content %}
<h3>Quản lý yêu cầu &amp; xếp lịch</h3>

<div class="mb-3 d-flex gap-2">
  <form method="post" action="{{ url_for('auto_schedule') }}">
    <button class="btn btn-outline-primary" type="submit">Chạy xếp lịch tự động</button>
  </form>
  <a class="btn btn-secondary" href="{{ url_for('dashboard') }}">Quay lại</a>
</div>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>#</th>
        <th>GV</th>
        <th>Lớp</th>
        <th>Ngày</th>
        <th>Tiết</th>
        <th>Nhóm phòng</th>
        <th>Ưu tiên</th>
        <th>Trạng thái</th>
        <th>Gán phòng</th>
        <th class="text-end">Thao tác</th>
      </tr>
    </thead>
    <tbody>
      {% for r in all_requests %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ r.teacher.full_name }}</td>
        <td>{{ r.class_name }}</td>
        <td>{{ r.date.strftime('%d/%m/%Y') }}</td>
        <td>{{ r.period }}</td>
        <td>{{ r.lab_group }}</td>
        <td>{{ r.preferred_lab.name if r.preferred_lab else '' }}</td>
        <td>
          <span class="badge text-bg-{% if r.status=='scheduled' %}success{% elif r.status=='conflict' %}danger{% elif r.status=='approved' %}warning{% else %}secondary{% endif %}">
			{% if r.status=='scheduled' %}Đã xếp lịch
			{% elif r.status=='conflict' %}Xung đột
			{% elif r.status=='approved' %}Đã duyệt
			{% else %}Đang chờ
			{% endif %}
</span>

        </td>
        <td>
          <form class="d-flex gap-2" method="post" action="{{ url_for('manual_assign', req_id=r.id) }}">
            <select class="form-select form-select-sm" name="lab_id">
              <option value="">-- chọn phòng --</option>
              {% for lab in labs %}
                <option value="{{ lab.id }}">{{ lab.subject_group }} - {{ lab.name }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-sm btn-outline-primary" type="submit">Gán</button>
          </form>
        </td>
        <td class="text-end">
          <form class="d-inline" method="post" action="{{ url_for('update_request_status', req_id=r.id) }}">
            <select class="form-select form-select-sm d-inline w-auto" name="status">
              <option value="pending" {{ 'selected' if r.status=='pending' else '' }}>Chờ</option>
              <option value="approved" {{ 'selected' if r.status=='approved' else '' }}>Đã duyệt</option>
              <option value="scheduled" {{ 'selected' if r.status=='scheduled' else '' }}>Đã xếp lịch</option>
              <option value="conflict" {{ 'selected' if r.status=='conflict' else '' }}>Xung đột</option>
            </select>
            <button class="btn btn-sm btn-outline-success" type="submit">Cập nhật</button>
          </form>

          {% if r.status == 'conflict' %}
            <button class="btn btn-sm btn-outline-danger" type="button"
                    data-bs-toggle="modal" data-bs-target="#aiModal{{ r.id }}">
              AI gợi ý
            </button>
          {% endif %}
        </td>
      </tr>

      {% if r.status == 'conflict' %}
      <div class="modal fade" id="aiModal{{ r.id }}" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">AI gợi ý phương án</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div id="aiAlert{{ r.id }}" class="alert alert-info">Đang tải gợi ý...</div>
              <div id="aiBody{{ r.id }}"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function loadAiSuggestion(reqId) {
  const alertEl = document.getElementById('aiAlert' + reqId);
  const bodyEl = document.getElementById('aiBody' + reqId);
  alertEl.className = 'alert alert-info';
  alertEl.textContent = 'Đang tải gợi ý...';
  bodyEl.innerHTML = '';

  fetch('/api/requests/' + reqId + '/ai_conflict')
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        alertEl.className = 'alert alert-danger';
        alertEl.textContent = data.message || data.error || 'Không lấy được gợi ý.';
        return;
      }
      alertEl.className = 'alert alert-success';
      alertEl.innerHTML = '<b>Lý do:</b> ' + (data.reason || '');

      let html = '';
      if (data.occupied && data.occupied.length) {
        html += '<h6 class="mt-3">Đang chiếm (ngày/tiết này)</h6><ul>';
        data.occupied.forEach(x => {
          html += '<li>' + x.lab_name + ' — ' + x.teacher_name + ' — ' + x.class_name + '</li>';
        });
        html += '</ul>';
      }
      if (data.suggestions && data.suggestions.length) {
        html += '<h6 class="mt-3">Gợi ý thời điểm thay thế</h6><ul>';
        data.suggestions.forEach(s => {
          html += '<li><b>' + s.date_str + '</b> — tiết <b>' + s.period + '</b> (phòng trống: ' + (s.free_lab_names||[]).join(', ') + ')</li>';
        });
        html += '</ul>';
      } else {
        html += '<div class="text-muted mt-3">Không tìm thấy gợi ý trong phạm vi quét.</div>';
      }
      bodyEl.innerHTML = html;
    })
    .catch(() => {
      alertEl.className = 'alert alert-danger';
      alertEl.textContent = 'Lỗi lấy gợi ý: không gọi được API.';
    });
}

// Khi mở modal thì load
document.addEventListener('shown.bs.modal', function (event) {
  const modal = event.target;
  const id = modal.id.replace('aiModal','');
  if (id) loadAiSuggestion(id);
});
</script>

{% endblock %}
