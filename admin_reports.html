{% extends "base.html" %}
{% block content %}
<h3>Báo cáo sử dụng phòng thực hành</h3>

<div class="card mb-3">
  <div class="card-body">
    <form method="post" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Chế độ</label>
        <select class="form-select" name="mode" id="mode">
          <option value="week" {{ 'selected' if report_data and report_data.mode=='week' else '' }}>Theo tuần</option>
          <option value="range" {{ 'selected' if report_data and report_data.mode=='range' else '' }}>Theo khoảng thời gian</option>
          <option value="month" {{ 'selected' if report_data and report_data.mode=='month' else '' }}>Theo tháng</option>
        </select>
      </div>

      <div class="col-md-4" id="weekBox">
        <label class="form-label">Chọn tuần</label>
        <select class="form-select" name="week_id">
          <option value="">-- Chọn tuần --</option>
          {% for w in weeks %}
            <option value="{{ w.id }}"
              {% if report_data and report_data.form and report_data.form.get('week_id') == (w.id|string) %}selected{% endif %}>
              Tuần {{ w.week_no }} ({{ w.school_year }}) — {{ w.start_date.strftime('%d/%m') }}→{{ w.end_date.strftime('%d/%m') }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2" id="rangeStart">
        <label class="form-label">Từ ngày</label>
        <input class="form-control" type="date" name="start_date" value="{{ report_data.form.get('start_date','') if report_data and report_data.form else '' }}">
      </div>
      <div class="col-md-2" id="rangeEnd">
        <label class="form-label">Đến ngày</label>
        <input class="form-control" type="date" name="end_date" value="{{ report_data.form.get('end_date','') if report_data and report_data.form else '' }}">
      </div>

      <div class="col-md-1" id="monthBox">
        <label class="form-label">Tháng</label>
        <input class="form-control" type="number" min="1" max="12" name="month" value="{{ report_data.form.get('month','') if report_data and report_data.form else '' }}">
      </div>
      <div class="col-md-2" id="yearBox">
        <label class="form-label">Năm</label>
        <input class="form-control" type="number" min="2000" max="2100" name="year" value="{{ report_data.form.get('year','') if report_data and report_data.form else today.year }}">
      </div>

      <div class="col-md-2">
        <button class="btn btn-primary w-100" type="submit">Xem báo cáo</button>
      </div>
      <div class="col-md-2">
        <button class="btn btn-outline-success w-100" type="submit" name="export" value="1">Xuất Word</button>
      </div>
    </form>
  </div>
</div>

{% if report_data %}
  <h4 class="mb-2">{{ report_data.title }}</h4>
  <div class="text-muted mb-3">
    {{ report_data.start_date.strftime('%d/%m/%Y') }} → {{ report_data.end_date.strftime('%d/%m/%Y') }}
  </div>

  <h5>Báo cáo theo giáo viên</h5>
  <div class="table-responsive mb-4">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>#</th><th>Giáo viên</th><th>Tổ/nhóm</th><th>SĐT</th><th>Số tiết thực hành</th>
        </tr>
      </thead>
      <tbody>
        {% for row in report_data.teacher_stats %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ row[0] or '' }}</td>
          <td>{{ row[1] or '' }}</td>
          <td>{{ row[2] or '' }}</td>
          <td>{{ row[3] or 0 }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="text-muted">Không có dữ liệu.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <h5>Báo cáo tổng hợp theo phòng máy</h5>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>#</th><th>Phòng máy</th><th>Nhóm phòng</th><th>Số tiết sử dụng</th>
        </tr>
      </thead>
      <tbody>
        {% for row in report_data.lab_stats %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ row[0] or '' }}</td>
          <td>{{ row[1] or '' }}</td>
          <td>{{ row[2] or 0 }}</td>
        </tr>
        {% else %}
        <tr><td colspan="4" class="text-muted">Không có dữ liệu.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

<a class="btn btn-secondary mt-3" href="{{ url_for('dashboard') }}">Quay lại</a>

<script>
function updateVisibility() {
  const mode = document.getElementById('mode').value;
  document.getElementById('weekBox').style.display = (mode === 'week') ? '' : 'none';
  document.getElementById('rangeStart').style.display = (mode === 'range') ? '' : 'none';
  document.getElementById('rangeEnd').style.display = (mode === 'range') ? '' : 'none';
  document.getElementById('monthBox').style.display = (mode === 'month') ? '' : 'none';
  document.getElementById('yearBox').style.display = (mode === 'month') ? '' : 'none';
  // yearBox dùng chung với month; nếu range thì vẫn ẩn
}
document.getElementById('mode').addEventListener('change', updateVisibility);
updateVisibility();
</script>
{% endblock %}
